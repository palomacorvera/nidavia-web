<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Viviendas de obra nueva · Nidavia</title>
  <link rel="stylesheet" href="css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
  <style>
  #listado{ color: var(--text-primary); }
  .meta span{
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    line-height:1;
  }
  </style>
</head>
<body>
<header id="header-placeholder" class="header loading">
  <div class="container nav">
    <div class="brand-lockup" style="opacity:.5;">Cargando...</div>
  </div>
</header>

  <!-- LISTADO OBRA NUEVA -->
  <section id="listado" class="section dark">
    <div class="container">
      <div class="head"><h1>Viviendas de obra nueva</h1></div>
      <div id="newbuild-cards" class="cards"></div>
    </div>
  </section>

  <!-- FOOTER dinámico -->

  <script type="module">
    import { loadPartials } from "./js/partials-loader.js";
    import { db } from "./js/firebase-config.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { initAuthUI } from "./js/auth-state.js";
    await loadPartials();
  initAuthUI();

    // === ICONOS & HELPERS ===
    const ICON_BED = '<svg viewBox="0 0 24 24"><path d="M4 10h16M6 10v8m12-8v8M8 18h8" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>';
    const ICON_BATH = '<svg viewBox="0 0 24 24"><path d="M7 10h10a2 2 0 0 1 2 2v6H5v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>';
    const ICON_AREA = '<svg viewBox="0 0 24 24"><path d="M4 20h16M4 4h16M4 12h16" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>';
    const ICON_HOME = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 21V9l9-6 9 6v12H3Z" stroke="currentColor" stroke-width="1.5"/></svg>';

    const euros = n => new Intl.NumberFormat('es-ES').format(n) + ' €';
    const cap   = s => s ? s.charAt(0).toUpperCase() + s.slice(1) : '';
    const esc   = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    function priceText(p){
      if(p.operation === 'alquiler') return euros(p.price) + ' /mes';
      return euros(p.price);
    }

    // === TARJETA ===
    function cardTemplate(p){
      const imgs = (p.gallery && p.gallery.length ? p.gallery : [p.image])
        .map((src,i)=>`<img loading="lazy" src="${esc(src)}" alt="${esc(p.title)} – foto ${i+1}">`)
        .join('');
      const ARROW_LEFT  = '<svg viewBox="0 0 24 24" fill="none"><path d="M15 5 8 12l7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      const ARROW_RIGHT = '<svg viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      const detailUrl = p.slug
        ? `detalle.html?slug=${encodeURIComponent(p.slug)}`
        : (p.id ? `detalle.html?id=${encodeURIComponent(p.id)}` : `detalle.html`);
      return `
      <article class="card">
        <div class="card-media">
          <div class="media-carousel" data-index="0">
            <div class="media-track">${imgs}</div>
            ${(p.gallery && p.gallery.length > 1) ? `
              <button class="media-nav media-prev" aria-label="Imagen anterior">${ARROW_LEFT}</button>
              <button class="media-nav media-next" aria-label="Imagen siguiente">${ARROW_RIGHT}</button>
            ` : ``}
          </div>
          <span class="badge">${priceText(p)}</span>
          ${p.tag ? `<span class="ribbon">${esc(cap(p.tag))}</span>` : ''}
        </div>

        <div class="card-body">
          <div class="card-title">
            <h3>${esc(p.title)}</h3>
            <span class="chip">${ICON_HOME} ${esc(cap(p.operation))}</span>
          </div>
          <div class="meta">
            ${p.bedrooms ? `<span>${ICON_BED} ${p.bedrooms} hab</span>` : ''}
            ${p.bathrooms ? `<span>${ICON_BATH} ${p.bathrooms} baños</span>` : ''}
            ${p.area_m2 ? `<span>${ICON_AREA} ${p.area_m2} m²</span>` : ''}
          </div>
          <div class="location">${esc(p.address)}</div>
          <div class="card-actions">
            <a class="ghost-link" href="${detailUrl}">Ver detalle</a>
            <a class="btn btn-outline" href="solicitar-visita.html?property=${encodeURIComponent(p.title)}">Solicitar visita</a>
          </div>
        </div>
      </article>`;
    }

    // === CARRUSELES ===
    function initCarousels(scopeSelector){
      document.querySelectorAll(`${scopeSelector} .media-carousel`).forEach(carousel=>{
        const track = carousel.querySelector('.media-track');
        const slides = track.children;
        let idx = 0;
        const update = ()=>{ track.style.transform = `translateX(-${idx*100}%)`; };
        carousel.querySelector('.media-prev')?.addEventListener('click', e=>{
          e.preventDefault(); idx = (idx - 1 + slides.length) % slides.length; update();
        });
        carousel.querySelector('.media-next')?.addEventListener('click', e=>{
          e.preventDefault(); idx = (idx + 1) % slides.length; update();
        });
        let startX = null;
        track.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; }, {passive:true});
        track.addEventListener('touchend', e=>{
          if(startX===null) return;
          const dx = e.changedTouches[0].clientX - startX;
          if(Math.abs(dx) > 50){
            idx = (dx < 0) ? (idx + 1) % slides.length : (idx - 1 + slides.length) % slides.length;
            update();
          }
          startX = null;
        });
        update();
      });
    }

    // === CARGAR PROPIEDADES ===
    async function loadNewBuild(){
      try {
        const querySnapshot = await getDocs(collection(db, "properties"));
        const all = [];
        querySnapshot.forEach(doc => all.push({ id: doc.id, ...doc.data() }));

        // Filtrar por "obra nueva"
        const newBuilds = all.filter(p =>
          p.operation && p.operation.toLowerCase().includes("obra nueva")
        );

        const cont = document.getElementById('newbuild-cards');
        if (newBuilds.length){
          cont.innerHTML = newBuilds.map(cardTemplate).join('');
          initCarousels('#newbuild-cards');
        } else {
          cont.innerHTML = `<p style="color:#fff;opacity:.85">No se encontraron viviendas de obra nueva.</p>`;
        }

        console.log(`✅ ${newBuilds.length} propiedades de obra nueva cargadas desde Firebase`);
      } catch(e) {
        console.error("❌ Error al cargar propiedades:", e);
        document.getElementById('newbuild-cards').innerHTML =
          '<p style="color:#fff;opacity:.85">No se pudieron cargar las viviendas de obra nueva.</p>';
      }
    }

    loadNewBuild();
  </script>

  <script type="module" src="js/newsletter.js"></script>
</body>
</html>
