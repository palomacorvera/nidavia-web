<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resultados de búsqueda · Nidavia</title>

  <link rel="stylesheet" href="css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">

  <style>
    /* Buscar: comportamiento del “quitar filtro” en los chips */
    .filters-applied .chip .x{
      cursor:pointer;
      opacity:.7;
      text-decoration:none;
    }
    .filters-applied .chip .x:hover{ opacity:1; }
  </style>
</head>

<body>
<header id="header-placeholder" class="header loading">
  <div class="container nav">
    <div class="brand-lockup" style="opacity:.5;">Cargando...</div>
  </div>
</header>

<main class="section">
  <div class="container">
    <div class="head">
      <h1>Resultados de búsqueda</h1>
      <div id="summary" class="filters-applied"></div>
    </div>

    <!-- Barra de filtros -->
    <div class="filters-bar">
      <div class="search" role="search" aria-label="Refinar búsqueda">
        <form id="filter-form" class="search-grid" action="buscar.html" method="GET">
          <label class="field" aria-label="Ubicación">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 22s7-5.686 7-12a7 7 0 1 0-14 0c0 6.314 7 12 7 12Z" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/></svg>
            <input type="text" name="u" placeholder="Ubicación, barrio o CP">
          </label>
          <label class="field" aria-label="Tipo">
            <select name="tipo">
              <option value="">Tipo</option>
              <option value="piso">Piso</option>
              <option value="chalet">Chalet</option>
              <option value="atico">Ático</option>
              <option value="duplex">Dúplex</option>
            </select>
          </label>
          <label class="field" aria-label="Precio mínimo">
            <select name="min">
              <option value="">Precio mín.</option>
              <option value="100000">100.000 €</option>
              <option value="200000">200.000 €</option>
              <option value="300000">300.000 €</option>
              <option value="500000">500.000 €</option>
            </select>
          </label>
          <label class="field" aria-label="Precio máximo">
            <select name="max">
              <option value="">Precio máx.</option>
              <option value="300000">300.000 €</option>
              <option value="500000">500.000 €</option>
              <option value="800000">800.000 €</option>
              <option value="1000000">1.000.000 €</option>
            </select>
          </label>
          <button class="btn btn-primary" type="submit">Aplicar filtros</button>
        </form>

        <div style="margin-top:8px">
          <a class="ghost-link" href="buscar.html">Borrar filtros</a>
        </div>
      </div>
    </div>

    <p id="count" style="margin:.9rem 0 0;color:var(--text-secondary)"></p>
    <div id="results" class="cards" style="margin-top:18px"></div>
  </div>
</main>

<script type="module">
  import { loadPartials } from "./js/partials-loader.js";
  import { db, auth } from "./js/firebase-config.js";
  import {
    collection,
    getDocs,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { onAuthStateChanged } from
    "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { initAuthUI } from "./js/auth-state.js";

  import {
    renderPropertyCard,
    initCarousels,
    initFavoriteButtons
  } from "./js/property-card.js";

  /* ================= INIT ================= */
  await loadPartials();
  initAuthUI();

  const grid = document.getElementById("results");
  const countEl = document.getElementById("count");

  let IS_LOGGED_IN = false;
  let CURRENT_USER = null;
  let USER_FAVORITES = new Set();
  let CARD_TEMPLATE_HTML = "";

  /* ================= TEMPLATE ================= */
  async function loadCardTemplate(){
    CARD_TEMPLATE_HTML = await fetch("partials/property-card.html")
      .then(r => r.text());
  }

  /* ================= FAVORITOS ================= */
  async function loadUserFavorites(uid){
    const ref = doc(db, "favorites", uid);
    const snap = await getDoc(ref);
    USER_FAVORITES.clear();

    if (snap.exists()){
      (snap.data().properties || []).forEach(id =>
        USER_FAVORITES.add(String(id))
      );
    }
  }

  /* ================= HELPERS BÚSQUEDA ================= */
  const norm = s => (s ?? '').toString()
    .normalize('NFD').replace(/\p{Diacritic}/gu,'')
    .toLowerCase().trim();

  const getRawType = p =>
    p.type ?? p.property_type ?? p.tipo ?? p.category ?? p.tag ?? '';

  const getType = p => norm(getRawType(p));

  const parsePrice = v => {
    if (typeof v === 'number') return v;
    const s = String(v ?? '').replace(/[^\d]/g,'');
    return s ? Number(s) : 0;
  };

  const getPrice = p => parsePrice(p.price ?? p.precio ?? p.price_eur ?? p.p);

  /* ================= PARAMS ================= */
  const params = new URLSearchParams(location.search);
  const qTipo = norm(params.get("tipo"));
  const qMin  = params.get("min") ? Number(params.get("min")) : null;
  const qMax  = params.get("max") ? Number(params.get("max")) : null;
  const qUbic = norm(params.get("u"));

  /* Rellenar formulario */
  const form = document.getElementById("filter-form");
  form.tipo.value = params.get("tipo") || "";
  form.min.value  = params.get("min")  || "";
  form.max.value  = params.get("max")  || "";
  form.u.value    = params.get("u")    || "";

  /* ================= CHIPS ================= */
  const summary = document.getElementById("summary");

  function addChip(label, key){
    const p = new URLSearchParams(params);
    p.delete(key);
    const url = "buscar.html" + (p.toString() ? "?" + p.toString() : "");
    const chip = document.createElement("span");
    chip.className = "chip";
    chip.innerHTML = `${label} <a class="x" href="${url}">✕</a>`;
    summary.appendChild(chip);
  }

  if (qTipo) addChip(`Tipo: ${params.get("tipo")}`, "tipo");
  if (qMin)  addChip(`Mín: ${qMin.toLocaleString("es-ES")} €`, "min");
  if (qMax)  addChip(`Máx: ${qMax.toLocaleString("es-ES")} €`, "max");
  if (qUbic) addChip(`Ubicación: ${params.get("u")}`, "u");

  if (!qTipo && !qMin && !qMax && !qUbic){
    summary.innerHTML =
      '<span style="color:var(--text-secondary)">Sin filtros activos</span>';
  }

  /* ================= DATA ================= */
  async function loadAndFilter(){
    const snapshot = await getDocs(collection(db, "properties"));
    const all = [];
    snapshot.forEach(d => all.push({ id:d.id, ...d.data() }));

    return all.filter(p => {
      const typeOk = !qTipo || getType(p) === qTipo;
      const price  = getPrice(p);
      const minOk  = qMin === null || price >= qMin;
      const maxOk  = qMax === null || price <= qMax;
      const locOk  = !qUbic || norm(p.address ?? "").includes(qUbic);
      return typeOk && minOk && maxOk && locOk;
    });
  }

  /* ================= RENDER ================= */
  async function renderResults(items){
    countEl.textContent =
      `${items.length} resultado${items.length !== 1 ? "s" : ""}`;

    if (!items.length){
      grid.innerHTML =
        '<p style="color:var(--text-secondary)">No hay propiedades que cumplan esos filtros.</p>';
      return;
    }

    const html = await Promise.all(
      items.map(p =>
        renderPropertyCard({
          property: p,
          templateHTML: CARD_TEMPLATE_HTML,
          isLogged: IS_LOGGED_IN,
          user: CURRENT_USER,
          favorites: USER_FAVORITES
        })
      )
    );

    grid.innerHTML = html.join("");

    initCarousels("#results");
    initFavoriteButtons({
      user: CURRENT_USER,
      favorites: USER_FAVORITES
    });
  }

  /* ================= FLOW ================= */
  onAuthStateChanged(auth, async user => {
    IS_LOGGED_IN = !!user;
    CURRENT_USER = user;

    if (user){
      await loadUserFavorites(user.uid);
    } else {
      USER_FAVORITES.clear();
    }

    await loadCardTemplate();
    const items = await loadAndFilter();
    await renderResults(items);
  });
</script>

<script type="module" src="js/newsletter.js"></script>
</body>
</html>
