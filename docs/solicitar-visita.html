<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Solicitar visita ¬∑ Nidavia</title>
  <link rel="stylesheet" href="css/main.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
  <style>
  /* Ajustes espec√≠ficos de esta p√°gina */
  #visit-section {
    padding-block: 64px 36px; /* margen inferior reducido */
    background: var(--bg-page);
  }
  #visit-section .container {
    max-width: 720px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-soft);
    padding: 32px;
  }
  #visit-section h1 {
    margin-top: 0;
    font-size: clamp(1.6rem, 2vw + 1rem, 2.4rem);
  }
  #visit-section p {
    color: var(--text-secondary);
    margin-bottom: 1.8rem;
  }

  /* Bot√≥n principal m√°s legible */
  #visit-form .btn-primary {
    font-size: 1.05rem; /* antes 1rem */
    padding: 1rem 1.6rem; /* un pel√≠n m√°s alto */
  }

 /* Estilo id√©ntico al resto sin doble recuadro */
#visit-form .field input[readonly],
#visit-form .field input.readonly {
  background-color: transparent; /* deja ver el fondo blanco del contenedor */
  border: none;                  /* elimina el borde interior */
  box-shadow: none;
  outline: none;
  color: var(--text-primary);
  cursor: default;
}

/* Asegura que al enfocar (aunque sea readonly) no aparezca contorno */
#visit-form .field input[readonly]:focus,
#visit-form .field input.readonly:focus {
  border: none;
  box-shadow: none;
  outline: none;
}

#visit-form .consent {
    margin-top: 15px;
}
/* Bot√≥n "Volver" alineado igual que en detalle.html */
.smart-back {
  display: flex;
  justify-content: flex-start;
  max-width: 780px;         
  margin: 24px auto -40px;  
  padding-left: 32px;       
}
.smart-back .btn {
  border-radius: 999px;
  font-weight: 600;
  padding: .65rem 1.1rem;
}


</style>

</head>
<body>
<header id="header-placeholder" class="header loading">
  <div class="container nav">
    <div class="brand-lockup" style="opacity:.5;">Cargando...</div>
  </div>
</header>

<nav id="smart-back" class="smart-back" hidden>
  <a id="smart-back-link" class="btn btn-outline" href="#">‚Üê Volver</a>
</nav>

  <!-- SECCI√ìN DE FORMULARIO -->
  <section id="visit-section">
    <div class="container">
      <h1>Solicitar una visita</h1>
      <p>D√©janos tus datos y te contactaremos para coordinar la visita al inmueble de tu inter√©s.</p>

      <form id="visit-form">
        <div class="fields">
          <div class="field"><input type="text" name="name" placeholder="Tu nombre completo" required></div>
          <div class="field"><input type="email" name="email" placeholder="Tu correo electr√≥nico" required></div>
          <div class="field"><input type="tel" name="phone" placeholder="Tel√©fono (opcional)"></div>
          <div class="field">
            <input type="text" id="property" name="property" placeholder="Inmueble de inter√©s (opcional)">
            </div>
          <div class="field"><input type="date" name="date" required></div>
          <div class="field"><input type="time" name="time" required></div>
        </div>


        <div class="form-row">
          <div class="field field--multiline">
            <textarea name="message" placeholder="Mensaje adicional (opcional)"></textarea>
          </div>
        </div>

        <label class="consent">
  <input type="checkbox" id="gdpr" name="gdpr" required>
  <span>Acepto la <a class="ghost-link" href="#">Pol√≠tica de privacidad</a>. *</span>
</label>


        <div id="form-success" class="success" role="status">¬°Gracias! Hemos recibido tu solicitud y te contactaremos pronto.</div>
        <div id="form-error" class="help">Por favor, revisa los campos requeridos.</div>

        <div class="form-row">
          <button id="send-btn" class="btn btn-primary" type="submit">Enviar solicitud</button>
        </div>
      </form>
    </div>
  </section>

  <script type="module">
    import { loadPartials } from "./js/partials-loader.js";
    import { db } from "./js/firebase-config.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { initAuthUI } from "./js/auth-state.js";
    await loadPartials();
  initAuthUI();
    
    // A√±o footer y cierre offcanvas
    document.getElementById('y').textContent = new Date().getFullYear();
    document.querySelectorAll('.offcanvas a').forEach(a =>
      a.addEventListener('click', () => document.querySelector('.offcanvas').classList.remove('open'))
    );

    // Formulario solicitud visita
    const form = document.getElementById('visit-form');
    const successBox = document.getElementById('form-success');
    const errorBox = document.getElementById('form-error');
    const sendBtn = document.getElementById('send-btn');

    // --- Precompletar el campo "Inmueble de inter√©s" desde la URL ---
const params = new URLSearchParams(window.location.search);
const propertyParam = params.get("property");

if (propertyParam) {
  const propertyInput = document.getElementById("property");
  propertyInput.value = decodeURIComponent(propertyParam);
  propertyInput.readOnly = true;
  propertyInput.classList.add("readonly");
}

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorBox.style.display = 'none';
      successBox.style.display = 'none';

      const data = new FormData(form);
      const name = data.get('name').trim();
      const email = data.get('email').trim();
      const phone = data.get('phone').trim();
      const property = data.get('property').trim();
      const date = data.get('date');
      const time = data.get('time');
      const message = data.get('message').trim();
      const gdpr = document.getElementById('gdpr').checked;

      if (!name || !email || !date || !time || !gdpr) {
        errorBox.style.display = 'block';
        return;
      }

      sendBtn.disabled = true;
      sendBtn.textContent = 'Enviando‚Ä¶';

      try {
        await addDoc(collection(db, "visitas"), {
          name, email, phone, property, date, time, message,
          createdAt: serverTimestamp()
        });
        successBox.style.display = 'block';
        form.reset();
        sendBtn.disabled = false;
        sendBtn.textContent = 'Enviar solicitud';
        successBox.scrollIntoView({ behavior: "smooth", block: "center" });
      } catch (err) {
        console.error("Error al guardar la visita:", err);
        errorBox.textContent = "Error al enviar la solicitud. Int√©ntalo m√°s tarde.";
        errorBox.style.display = 'block';
        sendBtn.disabled = false;
        sendBtn.textContent = 'Enviar solicitud';
      }
    });
// ===== Trail de navegaci√≥n en sessionStorage =====
function getTrail(){
  try { return JSON.parse(sessionStorage.getItem('trail') || '[]'); }
  catch { return []; }
}
function saveTrail(t){
  sessionStorage.setItem('trail', JSON.stringify(t.slice(-30)));
}
function pushHere(){
  const here = (location.pathname.split('/').pop() || 'index.html') + location.search;
  const t = getTrail();
  if (t[t.length - 1] !== here) {
    t.push(here);
    saveTrail(t);
  }
}
// Llama SIEMPRE al entrar en la p√°gina:
pushHere();

// ===== Bot√≥n inteligente de "Volver" =====
(function setupSmartBack(){
  const wrap = document.getElementById('smart-back');
  const link = document.getElementById('smart-back-link');
  if (!wrap || !link) return;

  const t = getTrail();
  let target = null;
  const here = (location.pathname.split('/').pop() || 'index.html') + location.search;

  // Buscamos la √∫ltima p√°gina base ANTES de llegar a esta solicitud
  const allowedBases = new Set([
    'index.html','viviendas.html','alquiler.html','obranueva.html','buscar.html'
  ]);

  // Recorremos el trail hacia atr√°s
  for (let i = t.length - 1; i >= 0; i--) {
    const url = t[i];
    const base = url.split('?')[0];

    // Saltar la propia p√°gina actual o cualquier detalle/solicitar-visita
    if (url === here) continue;
    if (base === 'detalle.html' || base === 'solicitar-visita.html') continue;

    // Primera base v√°lida encontrada
    if (allowedBases.has(base)) {
      target = url;
      break;
    }
  }

  wrap.hidden = false;

  if (target) {
    // Enlaza con la p√°gina base encontrada
    link.href = target;
  } else {
    // ü©π Si no hay rastro claro, fallback a index.html
    link.addEventListener('click', (e) => {
      e.preventDefault();
      if (history.length > 1) history.back();
      else location.href = 'index.html';
    });
  }
})();

  </script>

  <!-- Script global (newsletter, a√±o, offcanvas, etc.) -->
  <script type="module" src="js/newsletter.js"></script>
</body>
</html>
